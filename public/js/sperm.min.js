"use strict";function crds2ctx(e){var t=Game.Player.x-e.x,a=Game.Player.y-e.y;return{x:Game.View.width/2-t,y:Game.View.height/2-a}}function angleBetween(e,t){var a=t.y-e.y,o=t.x-e.x;return Math.atan(a/o)+(t.x<=e.x?Math.PI:0)}function sineCircleXYatAngle(e,t,a,o,n,i){var r=e+(a+o*Math.sin(i*n))*Math.cos(n),s=t+(a+o*Math.sin(i*n))*Math.sin(n);return{x:r,y:s}}function spawnFood(){Game.food.push(new Food)}function getDistance(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))-(t.radius+e.radius)}function areOverlapping(e,t,a){return getDistance(e,t)<0-(a||0)}function randomColor(){return"#"+Math.floor(16777215*Math.random()).toString(16)}function h2r(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}function drawAllFood(){for(var e=0;e<Game.food.length;e++)Game.food[e].fadeIn(.3),Game.food[e].checkForce(Game.Player),Game.food[e].draw(),Game.food[e].isEaten()&&(Game.food[e].color=Game.Player.color,Game.food[e].radius=.2*FOOD_RADIUS,Game.food[e].chained=!0,0!==Game.Player.score&&Game.Player.score%5!==0||Game.Player.food.push(Game.food[e]),SpermEvent.emit("player_eat_event",{player:Game.Player,food:Game.Food}),Game.Zoom.scale(),Game.Player.score++,Game.food.splice(e,1),e--);if(Game.Player.food[0]){Game.Player.food[0].followLeader(Game.Player),Game.Player.food[0].fadeIn(.1),Game.Player.food[0].draw();for(var t=1;t<Game.Player.food.length;t++)Game.Player.food[t].followLeader(Game.Player.food[t-1]),Game.Player.food[t].fadeIn(.1),Game.Player.food[t].draw()}}function Entity(e,t,a,o){var n=this;this.x=e,this.y=t,this.color=randomColor(),this.radius=a,this._id=null,this.set_id=function(e){return n._id=e},this.setX=function(e){return n.x=e},this.setY=function(e){return n.y=e},this.setColor=function(e){return n.color=e},this.setRadius=function(e){return n.radius=e},this.getX=function(){return n.x},this.getY=function(){return n.y},this.getColor=function(){return n.color},this.getRadius=function(){return n.radius}}function Player(e){var t=this;Entity.call(this,~~(300*Math.random()+MAP_SIZE/3),~~(300*Math.random()+MAP_SIZE/3),PLAYER_RADIUS),this.food=[],this.score=0,this.nitrus=!1,this.username=e,this.speed=SPEED,this.getScoreDecrease=function(){return.004*t.score},this.move=function(){t.y+=t.speed*Math.sin(theta),t.x+=t.speed*Math.cos(theta),SpermEvent.emit("player_move_event",{player:t})},this.update=function(){var e=angleBetween({x:window.innerWidth/2,y:window.innerHeight/2},mouse);theta=e,t.radius=PLAYER_RADIUS+.5*t.score},this.draw=function(e,a){var o=1.2,n=Math.floor(5*Math.random())+3,i=Math.floor(100*Math.random()),r=i+360;ctx.beginPath();for(var s=i;r>s;s++){var d=s*Math.PI/180,h=sineCircleXYatAngle(e,a,t.radius,o,d,n);ctx.lineTo(h.x,h.y)}doge.width=t.radius+5,doge.height=t.radius+5,t.nitrus===!0?(ctx.shadowColor="#ff5050",ctx.shadowBlur=30):(ctx.shadowColor="#595959",ctx.shadowBlur=20),ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.fillStyle=t.color,ctx.fill(),ctx.lineWidth=LINE_WIDTH,ctx.strokeStyle="rgb(r: "+h2r(t.color).r+", g: "+h2r(t.color).g+", b: "+(h2r(t.color).b+15)+")",ctx.closePath(),ctx.stroke(),ctx.font="20px Helvetica",ctx.shadowColor=t.color,ctx.shadowBlur=10,ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.fillStyle="black",ctx.textAlign="center",ctx.fillText(t.username,window.outerWidth/2,window.outerHeight/2+t.radius+20),ctx.shadowColor="rgba(0,0,0,0)"}}function Food(){Entity.call(this,Math.random()*Game.Map.width,Math.random()*Game.Map.height,FOOD_RADIUS),this.color=randomColor(),this.radius=.2*FOOD_RADIUS,this.chained=!1,this.draw=function(){var e=h2r(this.color);if(null!=e){var t=crds2ctx(this);this.chained&&Game.Player.nitrus===!0&&(ctx.shadowColor="#ff5050",ctx.shadowBlur=30,ctx.shadowBlur=10,ctx.shadowOffsetX=0,ctx.shadowOffsetY=0),ctx.fillStyle="rgba("+e.r+", "+(e.g+30)+", "+(e.b+30)+", 0.4)",ctx.beginPath(),ctx.arc(t.x,t.y,this.radius+4+1*Math.random(),0,2*Math.PI),ctx.closePath(),ctx.fill(),ctx.fillStyle=this.color,ctx.beginPath(),ctx.arc(t.x,t.y,this.radius+1*Math.random(),0,2*Math.PI),ctx.closePath(),ctx.fill()}},this.isEaten=function(){return areOverlapping(this,Game.Player,2)},this.checkForce=function(e){var t=getDistance(e,this),a=20,o=2,n=a-t+o;if(a>t){var i=angleBetween(this,e);this.y+=n*Math.sin(i),this.x+=n*Math.cos(i),this.radius=this.radius-.25*n<0?.1:this.radius-.25*n}},this.followLeader=function(e){var t=getDistance(e,this),a=20,o=a-t-SNAKINESS,n=angleBetween(this,e);this.y-=o*Math.sin(n),this.x-=o*Math.cos(n)},this.fadeIn=function(e){this.chained?this.radius=this.radius<FOOD_RADIUS+.2*Game.Player.score?this.radius+e:FOOD_RADIUS+.2*Game.Player.score:this.radius=this.radius<FOOD_RADIUS?this.radius+e:FOOD_RADIUS}}function EventEmitter(){var e=this;this.listeners={},this.on=function(t,a){e.listeners[t]?e.listeners[t].push(a):e.listeners[t]=[a]},this.emit=function(t,a){e.listeners[t]&&e.listeners[t].forEach(function(e){return e(a)})}}function Map(e,t){this.width=e,this.height=t,this.bkg=document.getElementById("source")}function startGame(e){music.play(),$(".wrapper").show(),$("#overlay").fadeOut(1e3),ws.send(JSON.stringify({name:"handshake",username:e})),Game.Map=new Map(4e3,4e3),Game.View=new View,Game.Player=new Player(e),Game.Zoom=new Zoom,Game.food=[],Game.View.resize(),document.body.onmousemove=function(e){mouse.x=e.clientX,mouse.y=e.clientY},document.addEventListener("keydown",function(e){32===e.keyCode&&(Game.Player.speed=2*SPEED,Game.Player.nitrus=!0)}),document.addEventListener("keyup",function(e){32===e.keyCode&&(Game.Player.speed=SPEED,Game.Player.nitrus=!1)}),window.onresize=function(e){Game.Zoom.updateZoom(),Game.View.resize()},setInterval(function(){Game.Player.update(),Game.Player.move(),document.getElementById("score").innerHTML=Game.Player.score},1e3/60),drawInterval=setInterval(function(){Game.View.draw()},1e3/120),spawnFoodInterval=setInterval(function(){Game.food.push(new Food)},1e3)}function stopGame(){music.pause(),clearInterval(drawInterval),clearInterval(spawnFoodInterval),Game={},$(".wrapper").hide(),$("#overlay").fadeIn("slow")}function View(){var e=this,t=document.getElementById("source"),a=document.createElement("canvas");window.ctx=a.getContext("2d"),ctx.canvas.width=this.width=window.innerWidth,ctx.canvas.height=this.height=window.innerHeight,document.body.appendChild(ctx.canvas),this.tempCanvas=ctx.canvas.cloneNode(!0),this.tempCanvas.style.position="absolute",this.tempCanvas.style.top=0,this.tempCanvas.style.left=0,this.tempCanvas.style["z-index"]=-1,this.tempCanvas.width=window.innerWidth,this.tempCanvas.height=window.innerHeight,this.tempContext=this.tempCanvas.getContext("2d"),document.body.appendChild(this.tempCanvas),this.resize=function(){var t=Game.Zoom.getZoom()>1?1-(Game.Zoom.getZoom()-1):1+(1-Game.Zoom.getZoom());e.tempContext.scale(t,t),e.tempContext.drawImage(ctx.canvas,0,0),e.tempCanvas.width=window.innerWidth,e.tempCanvas.height=window.innerHeight,e.width=window.outerWidth,e.height=window.outerHeight,ctx.canvas.width=window.innerWidth,ctx.canvas.height=window.innerHeight,Game.Zoom.scale(),setTimeout(function(){e.tempCanvas.width=window.innerWidth,e.tempCanvas.height=window.innerHeight},200)},this.draw=function(){ctx.fillStyle="#ff99cc",ctx.fillRect(0,0,window.outerWidth,window.outerHeight),ctx.drawImage(t,Game.Player.x-e.width/2,Game.Player.y-e.height/2,window.outerWidth,window.outerHeight,0,0,window.outerWidth,window.outerHeight),drawAllFood(),Game.Player.draw(e.width/2,e.height/2)}}function Zoom(){var e=this;this.baseWidth=window.outerWidth,this.relWidth=document.documentElement.clientWidth,this.getZoom=function(){return e.relWidth/e.baseWidth},this.updateZoom=function(){e.baseWidth=window.outerWidth,e.relWidth=document.documentElement.clientWidth},this.scale=function(){ctx.scale(Game.Zoom.getZoom(),Game.Zoom.getZoom())}}var music=new Audio("/audio/sperm.mp3"),pop=new Audio("/audio/pop.mp3");window.onload=function(){$("#overlay").fadeIn(1e3);var e=$("#nickname");$("#game_form").submit(function(t){return t.preventDefault(),e.val().length>13?void alert("Nickname cannot be longer than 13 characters!"):void startGame(e.val())});var t=document.getElementById("play_btn"),a=document.getElementById("mute_btn");t.addEventListener("mouseup",function(){$(t).hide(),$(a).show(),music.play()}),a.addEventListener("mouseup",function(){$(a).hide(),$(t).show(),music.pause()})};try{module.exports.angleBetween=angleBetween,module.exports.sineCircleXYatAngle=sineCircleXYatAngle,module.exports.getDistance=getDistance,module.exports.areOverlapping=areOverlapping,module.exports.randomColor=randomColor,module.exports.h2r=h2r}catch(e){console.log("Running in browser")}var doge=document.createElement("img");doge.src="https://cdn.thinglink.me/api/image/727110550026190849/1240/10/scaletowidth";var SpermEvent=new EventEmitter;SpermEvent.on("player_eat_event",function(e){pop.play()}),SpermEvent.on("player_move_event",function(e){$("#player_x").text(~~e.player.x),$("#player_y").text(~~e.player.y)});var Game={},SPEED=5,MAP_SIZE=4e3,FOOD_RADIUS=6,LINE_WIDTH=5,PLAYER_RADIUS=25,SNAKINESS=10,CTX=null,theta=0,mouse={x:0,y:0},PLAYER=new Player,drawInterval,spawnFoodInterval,ws=new WebSocket("ws://localhost:3000","echo-protocol");ws.onmessage=function(e){try{JSON.parse(e);messages[e.name](e)}catch(t){console.log("cannot parse the json :o")}};var messages={game:function(e){Game.food=e.food,Game.players=e.players}};SpermEvent.on("player_move_event",function(e){ws.send(JSON.stringify({id:"move",player:e.player}))}),SpermEvent.on("player_eat_event",function(e){ws.send(JSON.stringify({id:"eat",player:e.player,food:e.food}))});